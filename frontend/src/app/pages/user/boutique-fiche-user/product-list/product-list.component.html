<div class="mt-8">
    <!-- Header -->
    <div class="mb-6">
        <h2 class="text-3xl font-bold text-gray-900 dark:text-white mb-1">Products</h2>
        <p class="text-sm text-gray-500 dark:text-gray-400">{{ totalDocs }} product{{ totalDocs !== 1 ? 's' : '' }} available</p>
    </div>

    <!-- Search Bar -->
    <div class="relative mb-6">
        <input type="text" [(ngModel)]="searchTerm" (keyup.enter)="onSearch()"
               placeholder="Search for products..."
               class="w-full pl-12 pr-4 py-3.5 rounded-2xl border-2 border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-white placeholder-gray-400 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all shadow-sm"/>
        <svg class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
        </svg>
    </div>

    <!-- Layout: Sidebar + Products -->
    <div class="flex gap-8">

        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <!-- SIDEBAR FILTRES            -->
        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <aside class="hidden md:block w-64 flex-shrink-0">
            <div class="sticky top-6 space-y-6">

                <!-- Header filtres -->
                <div class="flex items-center justify-between">
                    <h3 class="text-base font-bold text-gray-900 dark:text-white">Filters</h3>
                    <button (click)="clearFilters()"
                            class="text-xs text-blue-600 dark:text-blue-400 font-semibold hover:underline transition-colors">
                        Clear all
                    </button>
                </div>

                <!-- Categories -->
                <div class="bg-white dark:bg-gray-800 rounded-2xl border border-gray-200 dark:border-gray-700 p-5">
                    <div class="flex items-center justify-between mb-4">
                        <h4 class="text-sm font-bold text-gray-900 dark:text-white uppercase tracking-wide">Category</h4>
                        <button *ngIf="selectedCategories.length > 0"
                                (click)="onCategoryChange('all')"
                                class="text-xs text-blue-600 dark:text-blue-400 font-semibold hover:underline">
                            Clear
                        </button>
                    </div>
                    <div class="space-y-1">
                        <label *ngFor="let cat of categories"
                               class="flex items-center gap-3 px-3 py-2 rounded-xl cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors group">
                            <div class="relative flex-shrink-0">
                                <input type="checkbox"
                                       [checked]="isCategorySelected(cat._id)"
                                       (change)="onCategoryChange(cat._id)"
                                       class="sr-only"/>
                                <div [ngClass]="isCategorySelected(cat._id)
                        ? 'bg-blue-600 border-blue-600'
                        : 'bg-white dark:bg-gray-800 border-gray-300 dark:border-gray-600 group-hover:border-blue-400'"
                                     class="w-4 h-4 rounded border-2 transition-colors flex items-center justify-center">
                                    <svg *ngIf="isCategorySelected(cat._id)" class="w-2.5 h-2.5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3.5">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/>
                                    </svg>
                                </div>
                            </div>
                            <span [ngClass]="isCategorySelected(cat._id)
                    ? 'text-blue-600 dark:text-blue-400 font-semibold'
                    : 'text-gray-600 dark:text-gray-400'"
                                  class="text-sm transition-colors">
                                {{ cat.name }}
                            </span>
                        </label>
                        <p *ngIf="categories.length === 0" class="text-xs text-gray-400 italic px-3 py-2">No categories</p>
                    </div>
                </div>

                <!-- Sort -->
                <div class="bg-white dark:bg-gray-800 rounded-2xl border border-gray-200 dark:border-gray-700 p-5">
                    <h4 class="text-sm font-bold text-gray-900 dark:text-white mb-4 uppercase tracking-wide">Sort By</h4>
                    <div class="space-y-1">
                        <button *ngFor="let opt of [
                            { value: '-createdAt', label: 'Newest' },
                            { value: 'createdAt', label: 'Oldest' },
                            { value: 'regularPrice', label: 'Price: Low to High' },
                            { value: '-regularPrice', label: 'Price: High to Low' },
                            { value: 'name', label: 'Name A â†’ Z' },
                            { value: '-name', label: 'Name Z â†’ A' }
                        ]"
                                (click)="onSortChange(opt.value)"
                                [ngClass]="sortBy === opt.value
                                    ? 'bg-blue-50 dark:bg-blue-900/20 text-blue-600 dark:text-blue-400 font-semibold'
                                    : 'text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white hover:bg-gray-50 dark:hover:bg-gray-700/50'"
                                class="w-full text-left px-3 py-2 rounded-xl text-sm transition-colors">
                            {{ opt.label }}
                        </button>
                    </div>
                </div>

                <!-- Price Range -->
                <div class="bg-white dark:bg-gray-800 rounded-2xl border border-gray-200 dark:border-gray-700 p-5">
                    <h4 class="text-sm font-bold text-gray-900 dark:text-white mb-4 uppercase tracking-wide">Price Range</h4>
                    <div class="space-y-3">
                        <div>
                            <label class="text-xs text-gray-500 dark:text-gray-400 mb-1 block">Min (Ar)</label>
                            <input type="number" [(ngModel)]="minPrice" (change)="applyPriceFilter()"
                                   placeholder="0" min="0"
                                   class="w-full px-3 py-2 rounded-xl border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-900 text-gray-900 dark:text-white text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"/>
                        </div>
                        <div>
                            <label class="text-xs text-gray-500 dark:text-gray-400 mb-1 block">Max (Ar)</label>
                            <input type="number" [(ngModel)]="maxPrice" (change)="applyPriceFilter()"
                                   placeholder="âˆž" min="0"
                                   class="w-full px-3 py-2 rounded-xl border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-900 text-gray-900 dark:text-white text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"/>
                        </div>
                    </div>
                </div>

                <!-- Rating -->
                <div class="bg-white dark:bg-gray-800 rounded-2xl border border-gray-200 dark:border-gray-700 p-5">
                    <h4 class="text-sm font-bold text-gray-900 dark:text-white mb-4 uppercase tracking-wide">Min Rating</h4>
                    <div class="flex items-center gap-1">
                        <button *ngFor="let star of [1,2,3,4,5]"
                                (click)="setMinRating(star === minRating ? 0 : star)"
                                class="p-0.5 hover:scale-110 transition-transform">
                            <svg class="w-6 h-6 transition-colors"
                                 [class.text-yellow-400]="star <= minRating"
                                 [class.text-gray-300]="star > minRating"
                                 fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                            </svg>
                        </button>
                        <span *ngIf="minRating > 0" class="text-xs text-gray-400 ml-1">& up</span>
                    </div>
                </div>

                <!-- On Sale -->
                <div class="bg-white dark:bg-gray-800 rounded-2xl border border-gray-200 dark:border-gray-700 p-5">
                    <h4 class="text-sm font-bold text-gray-900 dark:text-white mb-4 uppercase tracking-wide">Promotion</h4>
                    <button (click)="toggleSaleFilter()"
                            [ngClass]="onSaleOnly
                                ? 'bg-gradient-to-r from-red-500 to-pink-600 text-white shadow-lg shadow-red-500/20'
                                : 'bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300'"
                            class="w-full px-4 py-2.5 rounded-xl font-semibold text-sm transition-all">
                        {{ onSaleOnly ? 'ðŸ”¥ On Sale Only' : 'All Products' }}
                    </button>
                </div>

            </div>
        </aside>

        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <!-- CONTENU PRINCIPAL          -->
        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <div class="flex-1 min-w-0">

            <!-- Mobile filters toggle -->
            <div class="md:hidden mb-4">
                <button (click)="toggleFilters()"
                        class="inline-flex items-center gap-2 px-4 py-2.5 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-700 rounded-xl text-gray-700 dark:text-gray-300 font-medium text-sm hover:bg-gray-50 transition-colors">
                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"/>
                    </svg>
                    Filters
                    <span *ngIf="selectedCategories.length > 0 || onSaleOnly || minPrice || maxPrice || minRating"
                          class="inline-flex items-center justify-center w-5 h-5 rounded-full bg-blue-600 text-white text-xs font-bold">
                        {{ selectedCategories.length + (onSaleOnly ? 1 : 0) + (minPrice ? 1 : 0) + (maxPrice ? 1 : 0) + (minRating ? 1 : 0) }}
                    </span>
                </button>

                <!-- Mobile filters panel -->
                <div *ngIf="showFilters" class="mt-3 bg-white dark:bg-gray-800 rounded-2xl border border-gray-200 dark:border-gray-700 p-4 space-y-4">

                    <!-- Categories mobile -->
                    <div>
                        <p class="text-xs font-bold text-gray-700 dark:text-gray-300 uppercase tracking-wide mb-2">Categories</p>
                        <div class="flex flex-wrap gap-2">
                            <button *ngFor="let cat of categories"
                                    (click)="onCategoryChange(cat._id)"
                                    [ngClass]="isCategorySelected(cat._id)
                        ? 'bg-blue-600 text-white border-blue-600'
                        : 'bg-white dark:bg-gray-900 text-gray-600 dark:text-gray-400 border-gray-300 dark:border-gray-600'"
                                    class="px-3 py-1.5 rounded-xl border text-xs font-medium transition-colors">
                                {{ cat.name }}
                            </button>
                        </div>
                    </div>

                    <!-- Sort mobile -->
                    <div>
                        <p class="text-xs font-bold text-gray-700 dark:text-gray-300 uppercase tracking-wide mb-2">Sort By</p>
                        <select [(ngModel)]="sortBy" (ngModelChange)="onSortChange($event)"
                                class="w-full px-3 py-2 rounded-xl border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-900 text-sm text-gray-900 dark:text-white">
                            <option value="-createdAt">Newest</option>
                            <option value="regularPrice">Price â†‘</option>
                            <option value="-regularPrice">Price â†“</option>
                            <option value="name">A â†’ Z</option>
                        </select>
                    </div>

                    <!-- On sale mobile -->
                    <button (click)="toggleSaleFilter()"
                            [ngClass]="onSaleOnly
                ? 'bg-gradient-to-r from-red-500 to-pink-600 text-white'
                : 'bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300'"
                            class="w-full px-4 py-2.5 rounded-xl font-semibold text-sm transition-all">
                        {{ onSaleOnly ? 'ðŸ”¥ On Sale Only' : 'All Products' }}
                    </button>

                    <button (click)="clearFilters()"
                            class="w-full px-4 py-2 rounded-xl border border-gray-300 dark:border-gray-600 text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                        Clear all filters
                    </button>
                </div>
            </div>

            <!-- Loading Skeleton -->
            <div *ngIf="isLoading" class="grid grid-cols-2 lg:grid-cols-3 gap-6">
                <div *ngFor="let i of [1,2,3,4,5,6]" class="animate-pulse">

                    <!-- Image -->
                    <div class="aspect-square bg-gray-200 dark:bg-gray-700 rounded-2xl mb-3"></div>

                    <!-- Infos -->
                    <div class="space-y-1.5 px-1">
                        <!-- Name -->
                        <div class="h-4 bg-gray-200 dark:bg-gray-700 rounded w-3/4"></div>
                        <div class="h-4 bg-gray-200 dark:bg-gray-700 rounded w-1/2"></div>
                        <!-- Category -->
                        <div class="h-5 bg-gray-200 dark:bg-gray-700 rounded w-20"></div>
                        <!-- Rating -->
                        <div class="h-3 bg-gray-200 dark:bg-gray-700 rounded w-28"></div>
                        <!-- Price -->
                        <div class="h-5 bg-gray-200 dark:bg-gray-700 rounded w-24"></div>
                    </div>

                </div>
            </div>

            <!-- Empty State -->
            <div *ngIf="!isLoading && products.length === 0" class="flex flex-col items-center justify-center py-20 text-center">
                <!-- Illustration -->
                <div class="relative mb-8">
                    <div class="w-32 h-32 rounded-full bg-gradient-to-br from-blue-50 to-indigo-100 dark:from-blue-900/20 dark:to-indigo-900/20 flex items-center justify-center">
                        <svg class="w-16 h-16 text-blue-300 dark:text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"/>
                        </svg>
                    </div>
                    <!-- Floating dots dÃ©coratifs -->
                    <div class="absolute -top-1 -right-1 w-5 h-5 rounded-full bg-blue-200 dark:bg-blue-800 opacity-60"></div>
                    <div class="absolute -bottom-2 -left-2 w-3 h-3 rounded-full bg-indigo-300 dark:bg-indigo-700 opacity-40"></div>
                    <div class="absolute top-4 -left-4 w-2 h-2 rounded-full bg-blue-400 dark:bg-blue-600 opacity-50"></div>
                </div>

                <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-2">No products found</h3>
                <p class="text-sm text-gray-500 dark:text-gray-400 mb-8 max-w-xs">
                    Try adjusting your filters or search with different keywords
                </p>

                <button (click)="clearFilters()"
                        class="inline-flex items-center gap-2 px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-2xl transition-all hover:shadow-lg hover:shadow-blue-500/25 hover:-translate-y-0.5 text-sm">
                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                    </svg>
                    Reset filters
                </button>
            </div>

            <!-- Products Grid -->
            <div *ngIf="!isLoading && products.length > 0" class="grid grid-cols-2 lg:grid-cols-3 gap-6">
                <div *ngFor="let product of products" class="group">

                    <!-- Image Card -->
                    <div class="relative aspect-square overflow-hidden bg-gray-100 dark:bg-gray-800 rounded-2xl mb-3 shadow-sm cursor-pointer"
                         (click)="viewProduct(product._id)">
                        <img [src]="product.images[0] || '/product-placeholder.svg'" [alt]="product.name"
                             class="w-full h-full object-cover"/>

                        <!-- Sale Badge -->
                        <div *ngIf="product.isSale && calculateDiscount(product) > 0" class="absolute top-3 left-3 z-10">
                            <div class="px-2.5 py-1 bg-gradient-to-r from-red-500 to-pink-600 text-white rounded-full shadow-lg">
                                <span class="text-xs font-black">-{{ calculateDiscount(product) }}%</span>
                            </div>
                        </div>

                        <!-- Stock Badge -->
                        <div *ngIf="product.stockReal <= 10" class="absolute top-3 right-3 z-10">
                            <span *ngIf="product.stockReal === 0"
                                  class="inline-flex items-center gap-1 px-2 py-1 bg-gray-900/90 text-white text-xs font-bold rounded-full">
                                <span class="w-1.5 h-1.5 bg-red-500 rounded-full"></span>
                                Out of stock
                            </span>
                            <span *ngIf="product.stockReal > 0 && product.stockReal <= 10"
                                  class="px-2 py-1 bg-amber-500/90 text-white text-xs font-bold rounded-full">
                                {{ product.stockReal }} left
                            </span>
                        </div>
                    </div>

                    <!-- Infos en dessous -->
                    <div class="space-y-1.5 px-1">

                        <!-- Name -->
                        <h3 class="font-bold text-gray-900 dark:text-white text-xl line-clamp-2 leading-snug cursor-pointer hover:text-blue-600 dark:hover:text-blue-400 transition-colors"
                            (click)="viewProduct(product._id)">
                            {{ product.name }}
                        </h3>

                        <!-- Category -->
                        <span *ngIf="product.category"
                              class="inline-flex items-center px-2 py-0.5 rounded-md text-xs font-semibold bg-blue-50 dark:bg-blue-900/20 text-blue-600 dark:text-blue-400">
                            {{ product.category.name }}
                        </span>

                        <!-- Rating -->
                        <div class="flex items-center gap-1.5">
                            <app-rating-star [count]="getProductRating(product)" [max]="5"></app-rating-star>
                            <span class="text-xs text-gray-400 dark:text-gray-500">({{ product.totalRatings || 0 }})</span>
                        </div>

                        <!-- Price -->
                        <div class="flex items-baseline gap-2 pt-0.5">
                            <span *ngIf="product.isSale && product.salePrice"
                                  class="text-lg font-bold text-gray-900 dark:text-white">
                                {{ product.salePrice | number:'1.0-0' }} Ar
                            </span>
                            <span *ngIf="!product.isSale || !product.salePrice"
                                  class="text-lg font-bold text-gray-900 dark:text-white">
                                {{ product.regularPrice | number:'1.0-0' }} Ar
                            </span>
                            <span *ngIf="product.isSale && product.salePrice"
                                  class="text-sm text-gray-400 line-through">
                                {{ product.regularPrice | number:'1.0-0' }} Ar
                            </span>
                        </div>
                    </div>

                </div>
            </div>

            <!-- Pagination -->
            <div *ngIf="!isLoading && totalPages > 1" class="mt-10 flex items-center justify-center gap-2">
                <button (click)="goToPage(currentPage - 1)" [disabled]="currentPage === 1"
                        class="inline-flex items-center justify-center w-10 h-10 rounded-xl border-2 border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 hover:bg-gray-50 disabled:opacity-30 disabled:cursor-not-allowed transition-all">
                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/>
                    </svg>
                </button>

                <button *ngFor="let page of [].constructor(Math.min(totalPages, 5)); let i = index"
                        (click)="goToPage(i + 1)"
                        [ngClass]="currentPage === i + 1
                            ? 'bg-blue-600 text-white border-blue-600'
                            : 'bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 border-gray-300 dark:border-gray-600 hover:bg-gray-50'"
                        class="inline-flex items-center justify-center w-10 h-10 rounded-xl border-2 font-semibold transition-all">
                    {{ i + 1 }}
                </button>

                <button (click)="goToPage(currentPage + 1)" [disabled]="currentPage === totalPages"
                        class="inline-flex items-center justify-center w-10 h-10 rounded-xl border-2 border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 hover:bg-gray-50 disabled:opacity-30 disabled:cursor-not-allowed transition-all">
                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/>
                    </svg>
                </button>
            </div>

        </div>
    </div>
</div>