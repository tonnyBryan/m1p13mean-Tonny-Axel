<div class="mx-auto max-w-7xl">

    @if (isLoading) {
    <app-fiche-boutique-skeleton></app-fiche-boutique-skeleton>
    }

    @if (boutique) {

    <!-- Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">Shop Profile</h1>
        <p class="text-gray-600 dark:text-gray-400">Manage your shop information and delivery settings</p>
    </div>

    <!-- Tabs Navigation -->
    <div class="border-b border-gray-200 dark:border-gray-700 mb-6 overflow-x-auto scrollbar-hide">
        <nav class="-mb-px flex gap-4 sm:gap-8 w-max min-w-full px-1" aria-label="Tabs">
            <button (click)="activeTab = 'general'"
                [ngClass]="activeTab === 'general'
            ? 'border-brand-500 text-brand-600 dark:text-brand-400'
            : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-300'"
                class="whitespace-nowrap border-b-2 py-4 px-1 text-sm font-semibold transition-colors">
                <span class="flex items-center gap-2">
                    <svg width="18" height="18" viewBox="0 0 18 18" fill="none">
                        <path
                            d="M15 15.75H3C2.60218 15.75 2.22064 15.592 1.93934 15.3107C1.65804 15.0294 1.5 14.6478 1.5 14.25V5.25C1.5 4.85218 1.65804 4.47064 1.93934 4.18934C2.22064 3.90804 2.60218 3.75 3 3.75H6L7.5 1.5H10.5L12 3.75H15C15.3978 3.75 15.7794 3.90804 16.0607 4.18934C16.342 4.47064 16.5 4.85218 16.5 5.25V14.25C16.5 14.6478 16.342 15.0294 16.0607 15.3107C15.7794 15.592 15.3978 15.75 15 15.75Z"
                            stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                        <path
                            d="M9 12C10.2426 12 11.25 10.9926 11.25 9.75C11.25 8.50736 10.2426 7.5 9 7.5C7.75736 7.5 6.75 8.50736 6.75 9.75C6.75 10.9926 7.75736 12 9 12Z"
                            stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                    General Information
                </span>
            </button>

            <button (click)="activeTab = 'delivery'"
                [ngClass]="activeTab === 'delivery'
            ? 'border-brand-500 text-brand-600 dark:text-brand-400'
            : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-300'"
                class="whitespace-nowrap border-b-2 py-4 px-1 text-sm font-semibold transition-colors">
                <span class="flex items-center gap-2">
                    <svg width="18" height="18" viewBox="0 0 18 18" fill="none">
                        <path
                            d="M12 2.25H15C15.1989 2.25 15.3897 2.32902 15.5303 2.46967C15.671 2.61032 15.75 2.80109 15.75 3V15C15.75 15.1989 15.671 15.3897 15.5303 15.5303C15.3897 15.671 15.1989 15.75 15 15.75H3C2.80109 15.75 2.61032 15.671 2.46967 15.5303C2.32902 15.3897 2.25 15.1989 2.25 15V3C2.25 2.80109 2.32902 2.61032 2.46967 2.46967C2.61032 2.32902 2.80109 2.25 3 2.25H6M6 1.5V3.75M12 1.5V3.75M2.25 6.75H15.75"
                            stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                    Delivery Configuration
                </span>
            </button>

            <button (click)="activeTab = 'categories'"
                [ngClass]="activeTab === 'categories'
                ? 'border-brand-500 text-brand-600 dark:text-brand-400'
                : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-300'"
                class="whitespace-nowrap border-b-2 py-4 px-1 text-sm font-semibold transition-colors">
                <span class="flex items-center gap-2">
                    <svg width="18" height="18" viewBox="0 0 18 18" fill="none">
                        <path d="M3 3.75H15M3 9H15M3 14.25H9" stroke="currentColor" stroke-width="1.5"
                            stroke-linecap="round" stroke-linejoin="round" />
                        <path d="M12.75 12L14.25 13.5L17.25 10.5" stroke="currentColor" stroke-width="1.5"
                            stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                    Categories
                </span>
            </button>
        </nav>
    </div>

    <!-- Tab Content: General Information -->
    @if (activeTab === 'general') {
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

        <!-- Left Column: Shop Info -->
        <div class="lg:col-span-2 space-y-6">

            <!-- Card: Basic Info -->
            <div class="rounded-2xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 shadow-sm">
                <div class="border-b border-gray-200 dark:border-gray-700 px-6 py-4">
                    <h2 class="text-base font-semibold text-gray-800 dark:text-white">Shop Information</h2>
                </div>
                <div class="p-6 space-y-5">

                    <!-- Shop Name -->
                    <div>
                        <app-label for="shop-name">Shop Name <span class="text-red-500">*</span></app-label>
                        <app-input-field type="text" id="shop-name" [(ngModel)]="editName"
                            placeholder="Enter your shop name" />
                    </div>

                    <!-- Description -->
                    <div>
                        <app-label for="shop-desc">Description</app-label>
                        <textarea id="shop-desc" [(ngModel)]="editDescription"
                            placeholder="Tell customers about your shop…" rows="4"
                            class="w-full rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900 px-4 py-3 text-sm text-gray-800 dark:text-white placeholder-gray-400 dark:placeholder-gray-500 shadow-sm focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-transparent transition-colors duration-200 resize-none"></textarea>
                    </div>

                    <!-- Logo URL -->
                    <div>
                        <app-label for="shop-logo">Shop Logo</app-label>
                        <div class="mt-1.5">
                            <input type="file" id="shop-logo" accept="image/*" (change)="onLogoSelected($event)"
                                class="w-full text-sm text-gray-500 dark:text-gray-400
                                file:mr-4 file:py-2 file:px-4
                                file:rounded-xl file:border-0
                                file:text-sm file:font-semibold
                                file:bg-brand-50 file:text-brand-700
                                hover:file:bg-brand-100 dark:file:bg-brand-900/20 dark:file:text-brand-400
                                transition-all cursor-pointer border border-gray-200 dark:border-gray-700 rounded-xl p-2 bg-white dark:bg-gray-800" />
                        </div>
                        <p class="mt-2 text-xs text-gray-500 dark:text-gray-400">Recommended size: 200x200px. Max 5MB.
                        </p>
                    </div>

                </div>
            </div>

            <!-- Card: Account Info (Read-only) -->
            <div class="rounded-2xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 shadow-sm">
                <div class="border-b border-gray-200 dark:border-gray-700 px-6 py-4">
                    <h2 class="text-base font-semibold text-gray-800 dark:text-white">Account Information</h2>
                </div>
                <div class="p-6 space-y-4 text-sm">
                    <div class="flex items-center justify-between">
                        <span class="text-gray-500 dark:text-gray-400">Owner Name</span>
                        <span class="font-medium text-gray-900 dark:text-white">{{ boutique.owner.name }}</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-gray-500 dark:text-gray-400">Email</span>
                        <span class="font-medium text-gray-900 dark:text-white">{{ boutique.owner.email }}</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-gray-500 dark:text-gray-400">Shop ID</span>
                        <span class="font-mono text-xs text-gray-900 dark:text-white">{{ boutique._id }}</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-gray-500 dark:text-gray-400">Created</span>
                        <span class="font-medium text-gray-900 dark:text-white">{{ formatDate(boutique.createdAt)
                            }}</span>
                    </div>
                </div>
            </div>

        </div>

        <!-- Right Column: Preview & Status -->
        <div class="lg:col-span-1 space-y-6">

            <!-- Card: Logo Preview -->
            <div class="rounded-2xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 shadow-sm">
                <div class="border-b border-gray-200 dark:border-gray-700 px-6 py-4">
                    <h2 class="text-base font-semibold text-gray-800 dark:text-white">Logo Preview</h2>
                </div>
                <div class="p-6">
                    <div
                        class="aspect-square rounded-xl overflow-hidden bg-gray-100 dark:bg-gray-900 border-2 border-dashed border-gray-300 dark:border-gray-700 flex items-center justify-center">
                        @if (editLogo) {
                        <img [src]="editLogo" [alt]="editName" class="w-full h-full object-cover" />
                        } @else {
                        <div class="text-center p-4">
                            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor"
                                viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                            </svg>
                            <p class="mt-2 text-xs text-gray-500 dark:text-gray-400">No logo</p>
                        </div>
                        }
                    </div>
                </div>
            </div>

            <!-- Card: Status -->
            <div class="rounded-2xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 shadow-sm">
                <div class="border-b border-gray-200 dark:border-gray-700 px-6 py-4">
                    <h2 class="text-base font-semibold text-gray-800 dark:text-white">Status</h2>
                </div>
                <div class="p-6 space-y-4">
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-500 dark:text-gray-400">Shop Status</span>
                        <span class="inline-flex items-center gap-1.5 rounded-full px-2.5 py-1 text-xs font-semibold"
                            [ngClass]="boutique.isActive
                    ? 'bg-emerald-100 dark:bg-emerald-900/40 text-emerald-700 dark:text-emerald-400'
                    : 'bg-red-100 dark:bg-red-900/40 text-red-700 dark:text-red-400'">
                            <span class="h-1.5 w-1.5 rounded-full"
                                [ngClass]="boutique.isActive ? 'bg-emerald-500' : 'bg-red-500'"></span>
                            {{ boutique.isActive ? 'Active' : 'Inactive' }}
                        </span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-500 dark:text-gray-400">Validation</span>
                        <span class="inline-flex items-center gap-1.5 rounded-full px-2.5 py-1 text-xs font-semibold"
                            [ngClass]="boutique.isValidated
                    ? 'bg-blue-100 dark:bg-blue-900/40 text-blue-700 dark:text-blue-400'
                    : 'bg-amber-100 dark:bg-amber-900/40 text-amber-700 dark:text-amber-400'">
                            @if (boutique.isValidated) {
                            <svg width="12" height="12" viewBox="0 0 12 12" fill="none">
                                <path d="M10 3L4.5 8.5L2 6" stroke="currentColor" stroke-width="2"
                                    stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                            }
                            {{ boutique.isValidated ? 'Verified' : 'Pending' }}
                        </span>
                    </div>
                </div>
            </div>

            <!-- Save Button -->
            <app-button className="w-full" size="sm" [loading]="isGeneralLoading" [disabled]="!hasGeneralChanged()"
                (btnClick)="saveGeneralInfo()">
                Save Changes
            </app-button>

        </div>

    </div>
    }

    <!-- Tab Content: Delivery Configuration -->
    @if (activeTab === 'delivery') {
    <div class="max-w-4xl space-y-6">

        <!-- Card: Delivery Settings -->
        <div class="rounded-2xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 shadow-sm">
            <div class="border-b border-gray-200 dark:border-gray-700 px-6 py-4 flex items-center justify-between">
                <h2 class="text-base font-semibold text-gray-800 dark:text-white">Delivery Availability</h2>

                <!-- Global Delivery Toggle -->
                <div class="flex items-center gap-2">
                    <span class="text-sm text-gray-600 dark:text-gray-400">Enable Delivery</span>
                    <button type="button" (click)="toggleGlobalDelivery()"
                        class="relative inline-flex h-6 w-11 items-center rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-brand-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800"
                        [ngClass]="editDeliveryConfig.isDeliveryAvailable ? 'bg-brand-500' : 'bg-gray-200 dark:bg-gray-700'">
                        <span
                            class="inline-block h-4 w-4 transform rounded-full bg-white shadow-lg transition-transform duration-200"
                            [ngClass]="editDeliveryConfig.isDeliveryAvailable ? 'translate-x-6' : 'translate-x-1'">
                        </span>
                    </button>
                </div>
            </div>

            <div class="p-6 space-y-6">

                <!-- Order Cutoff Time -->
                <div>
                    <app-label for="cutoff-time">Daily Order Cutoff Time</app-label>
                    <input type="time" id="cutoff-time" [(ngModel)]="editDeliveryConfig.orderCutoffTime"
                        class="w-full rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900 px-4 py-2.5 text-sm text-gray-800 dark:text-white shadow-sm focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-transparent transition-colors duration-200" />
                    <p class="mt-1.5 text-xs text-gray-500 dark:text-gray-400">Orders placed after this time will be
                        delivered the next available day</p>
                </div>

                <!-- Delivery Days -->
                <div>
                    <app-label>Delivery Days</app-label>
                    <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mt-3">
                        @for (day of editDeliveryConfig.deliveryDays; track day._id) {
                        <button type="button" (click)="toggleDeliveryDay(day)"
                            class="flex items-center justify-between rounded-lg border-2 px-4 py-3 text-sm font-medium transition-all"
                            [ngClass]="day.isActive
                      ? 'border-brand-500 bg-brand-50 dark:bg-brand-900/20 text-brand-700 dark:text-brand-300'
                      : 'border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-600 dark:text-gray-400 hover:border-gray-300 dark:hover:border-gray-600'">
                            <span>{{ getDayName(day.day) }}</span>
                            @if (day.isActive) {
                            <svg width="16" height="16" viewBox="0 0 16 16" fill="none"
                                class="text-brand-600 dark:text-brand-400">
                                <path d="M13 4L6 11L3 8" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round" />
                            </svg>
                            }
                        </button>
                        }
                    </div>
                    <p class="mt-2 text-xs text-gray-500 dark:text-gray-400">
                        {{ getActiveDeliveryDaysCount() }} day(s) selected
                    </p>
                </div>

            </div>
        </div>

        <!-- Card: Pricing Rules -->
        <div class="rounded-2xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 shadow-sm">
            <div class="border-b border-gray-200 dark:border-gray-700 px-6 py-4">
                <h2 class="text-base font-semibold text-gray-800 dark:text-white">Delivery Pricing</h2>
            </div>
            <div class="p-6">
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-5">

                    <!-- Min Price -->
                    <div>
                        <app-label for="min-price">Minimum Price</app-label>
                        <div class="relative">
                            <span
                                class="absolute left-3 top-1/2 -translate-y-1/2 text-sm font-medium text-gray-500 dark:text-gray-400">$</span>
                            <input type="number" id="min-price" [(ngModel)]="editDeliveryConfig.deliveryRules.minPrice"
                                placeholder="0.00" min="0" step="0.01"
                                class="w-full rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900 pl-8 pr-4 py-2.5 text-sm text-gray-800 dark:text-white shadow-sm focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-transparent transition-colors duration-200" />
                        </div>
                    </div>

                    <!-- Base Distance -->
                    <div>
                        <app-label for="base-distance">Base Distance (km)</app-label>
                        <input type="number" id="base-distance"
                            [(ngModel)]="editDeliveryConfig.deliveryRules.baseDistanceKm" placeholder="5" min="0"
                            step="1"
                            class="w-full rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900 px-4 py-2.5 text-sm text-gray-800 dark:text-white shadow-sm focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-transparent transition-colors duration-200" />
                    </div>

                    <!-- Extra Price per km -->
                    <div>
                        <app-label for="extra-price">Extra Price/km</app-label>
                        <div class="relative">
                            <span
                                class="absolute left-3 top-1/2 -translate-y-1/2 text-sm font-medium text-gray-500 dark:text-gray-400">$</span>
                            <input type="number" id="extra-price"
                                [(ngModel)]="editDeliveryConfig.deliveryRules.extraPricePerKm" placeholder="0.00"
                                min="0" step="0.01"
                                class="w-full rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900 pl-8 pr-4 py-2.5 text-sm text-gray-800 dark:text-white shadow-sm focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-transparent transition-colors duration-200" />
                        </div>
                    </div>

                </div>

                <!-- Pricing Example -->
                <div
                    class="mt-6 rounded-lg bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 p-4">
                    <div class="flex gap-3">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="none"
                            class="text-blue-600 dark:text-blue-400 flex-shrink-0">
                            <path
                                d="M10 18C14.4183 18 18 14.4183 18 10C18 5.58172 14.4183 2 10 2C5.58172 2 2 5.58172 2 10C2 14.4183 5.58172 18 10 18Z"
                                stroke="currentColor" stroke-width="1.5" />
                            <path d="M10 6V10M10 13H10.01" stroke="currentColor" stroke-width="2"
                                stroke-linecap="round" />
                        </svg>
                        <div class="text-sm text-blue-800 dark:text-blue-300">
                            <p class="font-semibold mb-1">Example Calculation:</p>
                            <p>
                                For a <strong>10km delivery</strong>:
                                ${{ editDeliveryConfig.deliveryRules.minPrice }} +
                                ({{ 10 - editDeliveryConfig.deliveryRules.baseDistanceKm }} km × ${{
                                editDeliveryConfig.deliveryRules.extraPricePerKm }}) =
                                <strong>${{ calculateExamplePrice() }}</strong>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <app-button className="w-full" size="sm" [loading]="isDeliveryLoading" [disabled]="!hasDeliveryChanged()"
            (btnClick)="saveDeliveryConfig()">
            Save Delivery Settings
        </app-button>

    </div>
    }

    <div *ngIf="activeTab === 'categories'">
        <app-boutique-categories />
    </div>

    }

</div>