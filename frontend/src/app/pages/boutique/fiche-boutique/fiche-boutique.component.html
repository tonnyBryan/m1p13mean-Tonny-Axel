<div class="mx-auto max-w-7xl">

<!-- ══ SKELETON ══ -->
    @if (isLoading) {
        <app-fiche-boutique-skeleton></app-fiche-boutique-skeleton>
    }

    <!-- ══ CONTENT ══ -->
    @if (boutique) {
        <div class="space-y-0">

            <!-- ────────────────────────────────────────────
                 PROFILE HEADER CARD
            ──────────────────────────────────────────── -->
            <div class="rounded-2xl border border-gray-200 dark:border-white/[0.05] bg-white dark:bg-gray-900 shadow-sm mb-4">

                <!-- Cover -->
                <div class="relative h-36 sm:h-44 overflow-hidden rounded-t-2xl"
                     [ngClass]="boutique.isActive
                     ? 'bg-gradient-to-br from-brand-700 via-brand-800 to-indigo-900'
                     : 'bg-gradient-to-br from-gray-500 via-gray-600 to-gray-800'">
                    <div class="absolute inset-0 opacity-[0.07]"
                         style="background-image: radial-gradient(circle at 20% 55%, white 1.5px, transparent 1.5px), radial-gradient(circle at 75% 20%, white 1.5px, transparent 1.5px); background-size: 44px 44px;"></div>
                    <div class="absolute inset-x-0 bottom-0 h-24 bg-gradient-to-t from-black/35 to-transparent"></div>

                    <!-- Badges -->
                    <div class="absolute top-4 right-4 flex items-center gap-2">
                    <span class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full backdrop-blur-sm border text-xs font-bold"
                          [ngClass]="boutique.isValidated
                              ? 'bg-emerald-500/20 border-emerald-400/30 text-emerald-200'
                              : 'bg-amber-500/20 border-amber-400/30 text-amber-200'">
                        <svg *ngIf="boutique.isValidated" class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M6.267 3.455a3.066 3.066 0 001.745-.723 3.066 3.066 0 013.976 0 3.066 3.066 0 001.745.723 3.066 3.066 0 012.812 2.812c.051.643.304 1.254.723 1.745a3.066 3.066 0 010 3.976 3.066 3.066 0 00-.723 1.745 3.066 3.066 0 01-2.812 2.812 3.066 3.066 0 00-1.745.723 3.066 3.066 0 01-3.976 0 3.066 3.066 0 00-1.745-.723 3.066 3.066 0 01-2.812-2.812 3.066 3.066 0 00-.723-1.745 3.066 3.066 0 010-3.976 3.066 3.066 0 00.723-1.745 3.066 3.066 0 012.812-2.812zm7.44 5.252a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                        </svg>
                        <span *ngIf="!boutique.isValidated" class="w-1.5 h-1.5 rounded-full bg-amber-400"></span>
                        {{ boutique.isValidated ? 'Verified' : 'Pending Verification' }}
                    </span>
                        <span class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full backdrop-blur-sm border text-xs font-bold"
                              [ngClass]="boutique.isActive
                              ? 'bg-green-500/20 border-green-400/30 text-green-200'
                              : 'bg-red-500/20 border-red-400/30 text-red-200'">
                        <span class="w-1.5 h-1.5 rounded-full animate-pulse"
                              [ngClass]="boutique.isActive ? 'bg-green-400' : 'bg-red-400'"></span>
                            {{ boutique.isActive ? 'Active' : 'Inactive' }}
                    </span>
                    </div>
                </div>

                <!-- Avatar + actions -->
                <div class="px-5 sm:px-7 pb-6">
                    <div class="flex flex-col sm:flex-row sm:items-end sm:justify-between gap-4 -mt-11 sm:-mt-12 mb-4">

                        <!-- Logo -->
                        <div class="h-20 w-20 sm:h-24 z-999 sm:w-24 rounded-2xl overflow-hidden ring-4 ring-white dark:ring-gray-900 shadow-xl bg-gray-100 dark:bg-gray-800 flex-shrink-0">
                            <img *ngIf="boutique.logo" [src]="boutique.logo" [alt]="boutique.name" class="w-full h-full object-cover"/>
                            <div *ngIf="!boutique.logo"
                                 class="w-full h-full flex items-center justify-center bg-gradient-to-br from-brand-500 to-indigo-600">
                                <span class="text-2xl font-black text-white">{{ boutique.name?.charAt(0) }}</span>
                            </div>
                        </div>

                        <!-- Edit button (desktop) -->
                        <button (click)="openEditModal()"
                                class="hidden sm:inline-flex items-center gap-2 px-4 py-2 rounded-xl text-sm font-semibold border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 shadow-sm transition-all focus:outline-none focus:ring-2 focus:ring-brand-500 focus:ring-offset-2">
                            <svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 18 18">
                                <path fill-rule="evenodd" clip-rule="evenodd" d="M15.0911 2.78206C14.2125 1.90338 12.7878 1.90338 11.9092 2.78206L4.57524 10.116C4.26682 10.4244 4.0547 10.8158 3.96468 11.2426L3.31231 14.3352C3.25997 14.5833 3.33653 14.841 3.51583 15.0203C3.69512 15.1996 3.95286 15.2761 4.20096 15.2238L7.29355 14.5714C7.72031 14.4814 8.11172 14.2693 8.42013 13.9609L15.7541 6.62695C16.6327 5.74827 16.6327 4.32365 15.7541 3.44497L15.0911 2.78206Z"/>
                            </svg>
                            Edit Profile
                        </button>
                    </div>

                    <!-- Name + desc -->
                    <div class="flex items-center gap-2.5 flex-wrap">
                        <h1 class="text-xl sm:text-2xl font-black text-gray-900 dark:text-white tracking-tight">
                            {{ boutique.name }}
                        </h1>
                        <!-- Verified badge with custom SVG -->
                        <span *ngIf="boutique.isValidated" title="Verified shop" class="flex-shrink-0 inline-flex">
                            <img src="/images/error/success.svg" class="w-6 h-6 block dark:hidden" alt="Verified"/>
                            <img src="/images/error/success-dark.svg" class="w-6 h-6 hidden dark:block" alt="Verified"/>
                        </span>
                    </div>
                    <p class="mt-1 text-sm text-gray-500 dark:text-gray-400 leading-relaxed max-w-2xl">
                        {{ boutique.description }}
                    </p>

                    <!-- Meta chips -->
                    <div class="mt-3 flex flex-wrap items-center gap-3 text-xs text-gray-400 dark:text-gray-500">
                    <span class="flex items-center gap-1.5">
                        <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                        </svg>
                        {{ boutique.owner?.name }}
                    </span>
                        <span class="text-gray-200 dark:text-gray-700">•</span>
                        <span class="flex items-center gap-1.5">
                        <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                        </svg>
                        Since {{ formatDate(boutique.createdAt) }}
                    </span>
                        <span class="text-gray-200 dark:text-gray-700">•</span>
                        <span class="flex items-center gap-1.5 font-mono text-[11px]">
                        <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M7 20l4-16m2 16l4-16M6 9h14M4 15h14"/>
                        </svg>
                            {{ boutique._id }}
                    </span>
                    </div>

                    <!-- Edit mobile -->
                    <button (click)="openEditModal()"
                            class="mt-4 sm:hidden w-full inline-flex items-center justify-center gap-2 px-4 py-2.5 rounded-xl text-sm font-semibold border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 transition-all">
                        <svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 18 18">
                            <path fill-rule="evenodd" clip-rule="evenodd" d="M15.0911 2.78206C14.2125 1.90338 12.7878 1.90338 11.9092 2.78206L4.57524 10.116C4.26682 10.4244 4.0547 10.8158 3.96468 11.2426L3.31231 14.3352C3.25997 14.5833 3.33653 14.841 3.51583 15.0203C3.69512 15.1996 3.95286 15.2761 4.20096 15.2238L7.29355 14.5714C7.72031 14.4814 8.11172 14.2693 8.42013 13.9609L15.7541 6.62695C16.6327 5.74827 16.6327 4.32365 15.7541 3.44497L15.0911 2.78206Z"/>
                        </svg>
                        Edit Profile
                    </button>
                </div>
            </div>

            <!-- ────────────────────────────────────────────
                 TABS
            ──────────────────────────────────────────── -->
            <div class="bg-white dark:bg-gray-900 border border-gray-200 dark:border-white/[0.05] rounded-2xl mb-4 overflow-hidden">
                <div class="overflow-x-auto scrollbar-hide">
                    <nav class="flex min-w-max px-2">
                        <button *ngFor="let tab of tabs" (click)="activeTab = tab.key"
                                class="whitespace-nowrap flex items-center gap-2 px-4 py-4 text-sm font-semibold border-b-2 transition-colors"
                                [ngClass]="activeTab === tab.key
                                ? 'border-brand-500 text-brand-600 dark:text-brand-400'
                                : 'border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300'">
                            <span [innerHTML]="tab.icon" class="w-4 h-4 flex-shrink-0"></span>
                            {{ tab.label }}
                        </button>
                    </nav>
                </div>
            </div>

            <!-- ────────────────────────────────────────────
                 TAB PANELS
            ──────────────────────────────────────────── -->

            @if (activeTab === 'general') {
                <app-boutique-general-info
                        [boutique]="boutique"
                        (editRequested)="openEditModal()">
                </app-boutique-general-info>
            }

            @if (activeTab === 'delivery') {
                <app-boutique-delivery-config
                        [boutique]="boutique"
                        [isDeliveryLoading]="isDeliveryLoading"
                        (saveDelivery)="saveDeliveryConfig($event)">
                </app-boutique-delivery-config>
            }

            @if (activeTab === 'categories') {
                <app-boutique-categories></app-boutique-categories>
            }

            @if (activeTab === 'billing') {
                <app-boutique-billing [boutique]="boutique"></app-boutique-billing>
            }

        </div>
    }

    <!-- ══ MODAL: EDIT GENERAL INFO ══ -->
    <div *ngIf="isEditModalOpen"
         class="fixed inset-0 z-[999999] flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-lg max-h-[90vh] flex flex-col overflow-hidden">

            <div class="flex-shrink-0 flex items-center justify-between p-6 border-b border-gray-200 dark:border-gray-700">
                <div>
                    <h2 class="text-xl font-bold text-gray-900 dark:text-white">Edit Shop Profile</h2>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mt-0.5">Update your shop's public information</p>
                </div>
                <button type="button" (click)="closeEditModal()"
                        class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                    <svg class="w-5 h-5 text-gray-500 dark:text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>

            <div class="flex-1 overflow-y-auto custom-scrollbar p-6 space-y-5">

                <!-- Logo preview + upload -->
                <div class="flex items-start gap-4">
                    <div class="w-20 h-20 rounded-2xl overflow-hidden bg-gray-100 dark:bg-gray-700 border-2 border-dashed border-gray-300 dark:border-gray-600 flex items-center justify-center flex-shrink-0 shadow-inner">
                        <img *ngIf="editLogo" [src]="editLogo" [alt]="editName" class="w-full h-full object-cover"/>
                        <div *ngIf="!editLogo" class="w-full h-full flex items-center justify-center bg-gradient-to-br from-brand-500/20 to-indigo-500/20">
                            <svg class="w-8 h-8 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                            </svg>
                        </div>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1.5">Shop Logo</p>
                        <input type="file" accept="image/*" (change)="onLogoSelected($event)"
                               class="w-full text-xs text-gray-500 dark:text-gray-400
                                      file:mr-3 file:py-2 file:px-3 file:rounded-lg file:border-0
                                      file:text-xs file:font-semibold file:bg-brand-50 file:text-brand-700
                                      hover:file:bg-brand-100 dark:file:bg-brand-900/20 dark:file:text-brand-400
                                      cursor-pointer border border-gray-200 dark:border-gray-700 rounded-xl p-2
                                      bg-white dark:bg-gray-900 transition-all"/>
                        <p class="text-xs text-gray-400 mt-1.5">JPG, PNG or WEBP — Max 5MB</p>
                    </div>
                </div>

                <!-- Name -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1.5">
                        Shop Name <span class="text-red-500">*</span>
                    </label>
                    <input type="text" [(ngModel)]="editName" placeholder="Your shop name"
                           class="w-full px-4 py-3 rounded-xl border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-900 text-sm text-gray-900 dark:text-white placeholder-gray-400 dark:placeholder-gray-500 focus:ring-2 focus:ring-brand-500 focus:border-transparent transition-all"
                           [ngClass]="editName && editName.trim().length < 2 ? 'border-red-400 dark:border-red-500' : ''"/>
                    <p *ngIf="editName && editName.trim().length < 2"
                       class="mt-1.5 text-xs text-red-500 flex items-center gap-1">
                        <svg class="w-3 h-3 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/></svg>
                        Minimum 2 characters required
                    </p>
                </div>

                <!-- Description -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1.5">Description</label>
                    <textarea [(ngModel)]="editDescription" rows="4" placeholder="Tell customers about your shop…"
                              class="w-full px-4 py-3 rounded-xl border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-900 text-sm text-gray-900 dark:text-white placeholder-gray-400 dark:placeholder-gray-500 focus:ring-2 focus:ring-brand-500 focus:border-transparent transition-all resize-none"></textarea>
                </div>
            </div>

            <div class="flex-shrink-0 p-6 border-t border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900/50 flex items-center justify-end gap-3">
                <button type="button" (click)="closeEditModal()"
                        class="px-4 py-2.5 rounded-xl text-sm font-semibold border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 transition-all">
                    Cancel
                </button>
                <app-button size="sm" [loading]="isGeneralLoading" [disabled]="isSaveGeneralDisabled" (btnClick)="saveGeneralInfo()">
                    Save Changes
                </app-button>
            </div>
        </div>
    </div>

</div>
