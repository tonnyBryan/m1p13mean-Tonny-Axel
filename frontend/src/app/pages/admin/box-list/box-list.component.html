<div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
    <app-page-breadcrumb pageTitle="Boxes" [breadcrumbs]="[
        { label: 'Admin', link: '/admin/app' },
        { label: 'Boxes' }
    ]"></app-page-breadcrumb>

    <!-- ── Header ── -->
    <div class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between mb-6">
        <div>
            <h1 class="text-xl font-bold text-gray-900 dark:text-white">Box Management</h1>
            <p class="text-sm text-gray-500 dark:text-gray-400 mt-0.5">
                {{ boxes.length }} box{{ boxes.length !== 1 ? 'es' : '' }} total
            </p>
        </div>
        <button (click)="openModal()"
                class="inline-flex items-center gap-2 rounded-lg bg-brand-500 px-4 py-2.5 text-sm font-medium text-white shadow-theme-xs hover:bg-brand-600 transition-colors">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            New Box
        </button>
    </div>

    <!-- ── Filter tabs ── -->
    <div class="flex gap-2 mb-6">
        <button *ngFor="let f of filterOptions"
                (click)="onFilterChange(f.value)"
                [ngClass]="statusFilter === f.value
                ? 'bg-brand-500 text-white border-brand-500 shadow-sm'
                : 'bg-white dark:bg-gray-900 text-gray-600 dark:text-gray-400 border-gray-200 dark:border-gray-700 hover:border-brand-400 hover:text-brand-600'"
                class="inline-flex items-center gap-1.5 px-3.5 py-1.5 rounded-lg border text-sm font-medium transition-all">
            <span class="w-2 h-2 rounded-full"
                  [ngClass]="{
                    'bg-white/70':  statusFilter === f.value,
                    'bg-emerald-500': statusFilter !== f.value && f.value === 'occupe',
                    'bg-gray-400':  statusFilter !== f.value && f.value === 'vide',
                    'bg-gray-300':  statusFilter !== f.value && f.value === 'all'
                }">
            </span>
            {{ f.label }}
        </button>
    </div>

    <!-- ── Skeleton ── -->
    <div *ngIf="isLoading" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
        <div *ngFor="let i of [1,2,3,4,5,6,7,8]"
             class="rounded-xl border border-gray-200 dark:border-gray-800 bg-white dark:bg-white/[0.03] p-5 animate-pulse space-y-3">
            <div class="flex items-center justify-between">
                <div class="h-8 w-16 bg-gray-200 dark:bg-white/10 rounded-lg"></div>
                <div class="h-6 w-20 bg-gray-200 dark:bg-white/10 rounded-full"></div>
            </div>
            <div class="h-4 w-24 bg-gray-200 dark:bg-white/10 rounded"></div>
            <div class="h-10 w-full bg-gray-200 dark:bg-white/10 rounded-lg"></div>
        </div>
    </div>

    <!-- ── Cards Grid ── -->
    <div *ngIf="!isLoading && boxes.length > 0"
         class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">

        <div *ngFor="let box of boxes"
             class="group relative rounded-xl border bg-white dark:bg-white/[0.03] shadow-sm overflow-hidden transition-all hover:shadow-md"
             [ngClass]="box.isOccupied
                ? 'border-emerald-200 dark:border-emerald-500/20'
                : 'border-gray-200 dark:border-gray-800 hover:border-brand-300 dark:hover:border-brand-500/30'">

            <!-- Status strip top -->
            <div class="h-1 w-full"
                 [ngClass]="box.isOccupied ? 'bg-emerald-400 dark:bg-emerald-500' : 'bg-gray-200 dark:bg-gray-700'">
            </div>

            <div class="p-5">
                <!-- Number + Status -->
                <div class="flex items-start justify-between mb-3">
                    <div>
                        <p class="text-xs font-medium text-gray-400 dark:text-gray-500 uppercase tracking-wider mb-0.5">Box</p>
                        <h3 class="text-2xl font-black text-gray-900 dark:text-white leading-none">#{{ box.number }}</h3>
                    </div>
                    <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-semibold"
                          [ngClass]="box.isOccupied
                            ? 'bg-emerald-100 text-emerald-700 dark:bg-emerald-500/10 dark:text-emerald-400'
                            : 'bg-gray-100 text-gray-600 dark:bg-white/5 dark:text-gray-400'">
                        <span class="w-1.5 h-1.5 rounded-full"
                              [ngClass]="box.isOccupied ? 'bg-emerald-500' : 'bg-gray-400'"></span>
                        {{ box.isOccupied ? 'Occupied' : 'Available' }}
                    </span>
                </div>

                <!-- Price -->
                <div class="flex items-center gap-1.5 mb-4">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-gray-400">
                        <circle cx="12" cy="12" r="10"/>
                        <path d="M12 6v6l4 2"/>
                    </svg>
                    <span class="text-sm font-semibold text-gray-700 dark:text-gray-300">
                        {{ box.pricePerMonth.toLocaleString() }} Ar
                        <span class="text-xs font-normal text-gray-400">/ month</span>
                    </span>
                </div>

                <!-- Boutique info (clickable) -->
                <div *ngIf="box.boutiqueId"
                     (click)="router.navigate(['/admin/app/boutiques', box.boutiqueId._id])"
                     class="flex items-center gap-2.5 p-2.5 rounded-lg bg-gray-50 dark:bg-white/5 border border-gray-100 dark:border-gray-800 cursor-pointer hover:bg-brand-50 dark:hover:bg-brand-500/10 hover:border-brand-200 dark:hover:border-brand-500/30 transition-all group/boutique">
                    <img *ngIf="box.boutiqueId.logo" [src]="box.boutiqueId.logo"
                         class="w-8 h-8 rounded-lg object-cover border border-gray-200 dark:border-gray-700 shrink-0" />
                    <div *ngIf="!box.boutiqueId.logo"
                         class="w-8 h-8 rounded-lg bg-brand-100 dark:bg-brand-500/20 flex items-center justify-center shrink-0">
                        <span class="text-xs font-bold text-brand-600 dark:text-brand-400">
                            {{ box.boutiqueId.name?.charAt(0) }}
                        </span>
                    </div>
                    <span class="text-sm font-semibold text-gray-700 dark:text-gray-300 truncate group-hover/boutique:text-brand-600 dark:group-hover/boutique:text-brand-400 transition-colors">
                        {{ box.boutiqueId.name }}
                    </span>
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                         class="ml-auto shrink-0 text-gray-400 group-hover/boutique:text-brand-500 transition-colors">
                        <polyline points="9 18 15 12 9 6"></polyline>
                    </svg>
                </div>

                <div *ngIf="!box.boutiqueId"
                     class="flex items-center gap-2 p-2.5 rounded-lg bg-gray-50 dark:bg-white/[0.02] border border-dashed border-gray-200 dark:border-gray-800">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="text-gray-400">
                        <rect x="2" y="3" width="20" height="14" rx="2"/>
                        <path d="M8 21h8M12 17v4"/>
                    </svg>
                    <span class="text-xs text-gray-400 dark:text-gray-600">No store assigned</span>
                </div>

                <!-- Actions -->
                <div class="flex items-center gap-2 mt-3 pt-3 border-t border-gray-100 dark:border-gray-800">
                    <!-- Edit — disabled si occupé -->
                    <button (click)="openModal(box)"
                            [disabled]="box.isOccupied"
                            [title]="box.isOccupied ? 'Cannot edit an occupied box' : 'Edit'"
                            class="flex-1 inline-flex items-center justify-center gap-1.5 rounded-lg border px-3 py-1.5 text-xs font-medium transition-colors"
                            [ngClass]="box.isOccupied
                            ? 'border-gray-100 dark:border-gray-800 bg-gray-50 dark:bg-white/[0.02] text-gray-300 dark:text-gray-700 cursor-not-allowed'
                            : 'border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-600 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-white/5 hover:text-brand-500 dark:hover:text-brand-400'">
                        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/>
                            <path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/>
                        </svg>
                        Edit
                    </button>

                    <!-- Delete — avec spinner, seulement si non-occupé -->
                    <button *ngIf="!box.isOccupied" (click)="deleteBox(box)"
                            [disabled]="deletingId === box._id"
                            class="flex-1 inline-flex items-center justify-center gap-1.5 rounded-lg border border-red-200 dark:border-red-500/20 bg-white dark:bg-gray-800 px-3 py-1.5 text-xs font-medium text-red-500 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-500/10 disabled:opacity-60 disabled:cursor-not-allowed transition-colors">
                        <svg *ngIf="deletingId === box._id" class="animate-spin" width="13" height="13" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8H4z"/>
                        </svg>
                        <svg *ngIf="deletingId !== box._id" width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="3 6 5 6 21 6"/>
                            <path d="M19 6l-1 14H6L5 6"/>
                            <path d="M10 11v6M14 11v6"/>
                            <path d="M9 6V4h6v2"/>
                        </svg>
                        {{ deletingId === box._id ? 'Deleting...' : 'Delete' }}
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ── Empty State ── -->
    <div *ngIf="!isLoading && boxes.length === 0"
         class="flex flex-col items-center justify-center py-20 rounded-xl border border-dashed border-gray-200 dark:border-gray-800 bg-white dark:bg-white/[0.02]">
        <div class="rounded-2xl bg-gray-100 dark:bg-white/[0.05] p-5 mb-4">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="text-gray-300 dark:text-gray-600">
                <rect x="2" y="3" width="20" height="14" rx="2"/>
                <path d="M8 21h8M12 17v4"/>
            </svg>
        </div>
        <p class="text-sm font-semibold text-gray-500 dark:text-gray-400">No boxes found</p>
        <p class="text-xs text-gray-400 dark:text-gray-600 mt-1">Try changing the filter or create a new box</p>
        <button (click)="openModal()"
                class="mt-4 inline-flex items-center gap-2 rounded-lg bg-brand-500 px-4 py-2 text-xs font-semibold text-white hover:bg-brand-600 transition-colors">
            New Box
        </button>
    </div>
</div>

<!-- ── Modal ── -->
<div *ngIf="showModal"
     class="fixed inset-0 z-[999999] flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm">

    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-md flex flex-col overflow-hidden">

        <!-- Modal Header -->
        <div class="flex items-center justify-between p-6 border-b border-gray-200 dark:border-gray-700">
            <div>
                <h2 class="text-xl font-bold text-gray-900 dark:text-white">
                    {{ isEditing ? 'Edit Box' : 'New Box' }}
                </h2>
                <p class="text-sm text-gray-500 dark:text-gray-400 mt-0.5">
                    {{ isEditing ? 'Update box number and monthly price' : 'Fill in the details to create a new box' }}
                </p>
            </div>
            <button type="button" (click)="closeModal()" [disabled]="isSaving"
                    class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors disabled:opacity-50">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>

        <!-- Modal Body -->
        <form #boxForm="ngForm" (ngSubmit)="onSubmit(boxForm)">
            <div class="p-6 space-y-4">

                <!-- Box Number -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1.5">
                        Box Number <span class="text-red-500">*</span>
                    </label>
                    <input type="text" name="number" [(ngModel)]="currentBox.number" required
                           placeholder="e.g. A01, B12..."
                           class="w-full rounded-xl border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-900 px-4 py-2.5 text-sm text-gray-900 dark:text-white placeholder-gray-400 dark:placeholder-gray-500 focus:ring-2 focus:ring-brand-500 focus:border-transparent transition-all outline-none" />
                </div>

                <!-- Monthly Price -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1.5">
                        Monthly Price (Ar) <span class="text-red-500">*</span>
                    </label>
                    <div class="relative">
                        <input type="number" name="pricePerMonth" [(ngModel)]="currentBox.pricePerMonth"
                               required min="0" placeholder="0"
                               class="w-full rounded-xl border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-900 px-4 py-2.5 pr-12 text-sm text-gray-900 dark:text-white placeholder-gray-400 dark:placeholder-gray-500 focus:ring-2 focus:ring-brand-500 focus:border-transparent transition-all outline-none" />
                        <span class="absolute right-4 top-1/2 -translate-y-1/2 text-sm font-semibold text-gray-400">Ar</span>
                    </div>
                </div>

            </div>

            <!-- Modal Footer -->
            <div class="p-6 border-t border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900/50 flex gap-3">
                <button type="button" (click)="closeModal()" [disabled]="isSaving"
                        class="flex-1 px-4 py-2.5 rounded-xl border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-sm font-semibold text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 disabled:opacity-50 transition-colors">
                    Cancel
                </button>
                <button type="submit" [disabled]="boxForm.invalid || isSaving"
                        class="flex-1 inline-flex items-center justify-center gap-2 px-4 py-2.5 rounded-xl bg-brand-500 hover:bg-brand-600 disabled:opacity-50 disabled:cursor-not-allowed text-sm font-semibold text-white transition-colors">
                    <svg *ngIf="isSaving" class="animate-spin w-4 h-4" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8H4z"/>
                    </svg>
                    {{ isSaving ? (isEditing ? 'Saving...' : 'Creating...') : (isEditing ? 'Save Changes' : 'Create Box') }}
                </button>
            </div>
        </form>

    </div>
</div>