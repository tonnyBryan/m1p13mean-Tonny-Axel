<div class="relative">
    <button
            class="relative flex items-center justify-center text-gray-500 transition-colors bg-white border border-gray-200 rounded-full dropdown-toggle hover:text-gray-700 h-11 w-11 hover:bg-gray-100 dark:border-gray-800 dark:bg-gray-900 dark:text-gray-400 dark:hover:bg-gray-800 dark:hover:text-white"
            (click)="toggleDropdown()"
    >
        <!-- Badge with count -->
        <span
                *ngIf="notifying && totalUnread > 0"
                class="absolute -right-1 -top-1 z-10 flex h-5 min-w-5 items-center justify-center rounded-full bg-red-500 px-1 text-xs font-bold text-white"
        >
            {{ totalUnread > 9 ? '9+' : totalUnread }}
        </span>
        <svg
                class="fill-current"
                width="20"
                height="20"
                viewBox="0 0 20 20"
                xmlns="http://www.w3.org/2000/svg"
        >
            <path
                    fill-rule="evenodd"
                    clip-rule="evenodd"
                    d="M10.75 2.29248C10.75 1.87827 10.4143 1.54248 10 1.54248C9.58583 1.54248 9.25004 1.87827 9.25004 2.29248V2.83613C6.08266 3.20733 3.62504 5.9004 3.62504 9.16748V14.4591H3.33337C2.91916 14.4591 2.58337 14.7949 2.58337 15.2091C2.58337 15.6234 2.91916 15.9591 3.33337 15.9591H4.37504H15.625H16.6667C17.0809 15.9591 17.4167 15.6234 17.4167 15.2091C17.4167 14.7949 17.0809 14.4591 16.6667 14.4591H16.375V9.16748C16.375 5.9004 13.9174 3.20733 10.75 2.83613V2.29248ZM14.875 14.4591V9.16748C14.875 6.47509 12.6924 4.29248 10 4.29248C7.30765 4.29248 5.12504 6.47509 5.12504 9.16748V14.4591H14.875ZM8.00004 17.7085C8.00004 18.1228 8.33583 18.4585 8.75004 18.4585H11.25C11.6643 18.4585 12 18.1228 12 17.7085C12 17.2943 11.6643 16.9585 11.25 16.9585H8.75004C8.33583 16.9585 8.00004 17.2943 8.00004 17.7085Z"
                    fill="currentColor"
            />
        </svg>
    </button>

    <app-dropdown
            [isOpen]="isOpen"
            (close)="closeDropdown()"
            className="absolute -right-[300px] mt-[17px] flex h-[650px] w-[480px] flex-col rounded-2xl border border-gray-200 bg-white shadow-theme-lg dark:border-gray-800 dark:bg-gray-dark sm:w-[500px] lg:right-0"
    >
        <!-- Header -->
        <div class="flex items-center justify-between px-5 py-4 border-b border-gray-100 dark:border-gray-700">
            <div>
                <h5 class="text-lg font-bold text-gray-800 dark:text-gray-200">Notifications</h5>
                <p class="text-xs text-gray-500 dark:text-gray-400 mt-0.5">
                    {{ totalUnread > 0 ? totalUnread + ' unread' : 'All caught up!' }}
                </p>
            </div>
            <div class="flex items-center gap-2">
                <!-- Mark all as read -->
                <button
                        *ngIf="totalUnread > 0"
                        (click)="markAllAsRead()"
                        class="text-xs font-semibold text-brand-600 hover:text-brand-700 dark:text-brand-400 dark:hover:text-brand-300 transition-colors"
                        title="Mark all as read"
                >
                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                </button>
                <!-- Close button -->
                <button
                        (click)="toggleDropdown()"
                        class="text-gray-500 transition dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200"
                >
                    <svg class="fill-current" width="20" height="20" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M6.21967 7.28131C5.92678 6.98841 5.92678 6.51354 6.21967 6.22065C6.51256 5.92775 6.98744 5.92775 7.28033 6.22065L11.999 10.9393L16.7176 6.22078C17.0105 5.92789 17.4854 5.92788 17.7782 6.22078C18.0711 6.51367 18.0711 6.98855 17.7782 7.28144L13.0597 12L17.7782 16.7186C18.0711 17.0115 18.0711 17.4863 17.7782 17.7792C17.4854 18.0721 17.0105 18.0721 16.7176 17.7792L11.999 13.0607L7.28033 17.7794C6.98744 18.0722 6.51256 18.0722 6.21967 17.7794C5.92678 17.4865 5.92678 17.0116 6.21967 16.7187L10.9384 12L6.21967 7.28131Z" fill="currentColor"/>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Notifications List -->
        <ul #notifList class="flex flex-col h-auto overflow-y-auto custom-scrollbar p-2">
            <ng-container *ngIf="notifications.length > 0; else emptyState">
                <li *ngFor="let notif of notifications" class="mb-1 last:mb-0">
                    <button
                            (click)="onNotificationClick(notif)"
                            class="w-full text-left flex gap-3 rounded-xl p-3 transition-all"
                            [ngClass]="{
                            'bg-brand-50 dark:bg-brand-900/10 hover:bg-brand-100 dark:hover:bg-brand-900/20': !notif.isRead,
                            'hover:bg-gray-50 dark:hover:bg-white/[0.03]': notif.isRead
                        }"
                    >
                        <!-- Icon based on channel -->
                        <div class="relative flex-shrink-0">
                            <div
                                    class="w-10 h-10 rounded-full flex items-center justify-center"
                                    [ngClass]="{
                                    'bg-blue-100 dark:bg-blue-900/30': getNotificationColor(notif) === 'blue',
                                    'bg-green-100 dark:bg-green-900/30': getNotificationColor(notif) === 'green',
                                    'bg-amber-100 dark:bg-amber-900/30': getNotificationColor(notif) === 'amber',
                                    'bg-purple-100 dark:bg-purple-900/30': getNotificationColor(notif) === 'purple',
                                    'bg-gray-100 dark:bg-gray-800': getNotificationColor(notif) === 'gray'
                                }"
                            >
                                <!-- Order Icon -->
                                <svg *ngIf="getNotificationIcon(notif) === 'order'" class="w-5 h-5"
                                     [ngClass]="{'text-blue-600 dark:text-blue-400': getNotificationColor(notif) === 'blue'}"
                                     fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"/>
                                    <path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"/>
                                </svg>
                                <!-- Sale Icon -->
                                <svg *ngIf="getNotificationIcon(notif) === 'sale'" class="w-5 h-5"
                                     [ngClass]="{'text-green-600 dark:text-green-400': getNotificationColor(notif) === 'green'}"
                                     fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M8.433 7.418c.155-.103.346-.196.567-.267v1.698a2.305 2.305 0 01-.567-.267C8.07 8.34 8 8.114 8 8c0-.114.07-.34.433-.582zM11 12.849v-1.698c.22.071.412.164.567.267.364.243.433.468.433.582 0 .114-.07.34-.433.582a2.305 2.305 0 01-.567.267z"/>
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-13a1 1 0 10-2 0v.092a4.535 4.535 0 00-1.676.662C6.602 6.234 6 7.009 6 8c0 .99.602 1.765 1.324 2.246.48.32 1.054.545 1.676.662v1.941c-.391-.127-.68-.317-.843-.504a1 1 0 10-1.51 1.31c.562.649 1.413 1.076 2.353 1.253V15a1 1 0 102 0v-.092a4.535 4.535 0 001.676-.662C13.398 13.766 14 12.991 14 12c0-.99-.602-1.765-1.324-2.246A4.535 4.535 0 0011 9.092V7.151c.391.127.68.317.843.504a1 1 0 101.511-1.31c-.563-.649-1.413-1.076-2.354-1.253V5z" clip-rule="evenodd"/>
                                </svg>
                                <!-- Stock Icon -->
                                <svg *ngIf="getNotificationIcon(notif) === 'stock'" class="w-5 h-5"
                                     [ngClass]="{'text-amber-600 dark:text-amber-400': getNotificationColor(notif) === 'amber'}"
                                     fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M3 1a1 1 0 000 2h1.22l.305 1.222a.997.997 0 00.01.042l1.358 5.43-.893.892C3.74 11.846 4.632 14 6.414 14H15a1 1 0 000-2H6.414l1-1H14a1 1 0 00.894-.553l3-6A1 1 0 0017 3H6.28l-.31-1.243A1 1 0 005 1H3zM16 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zM6.5 18a1.5 1.5 0 100-3 1.5 1.5 0 000 3z"/>
                                </svg>
                                <!-- Message Icon -->
                                <svg *ngIf="getNotificationIcon(notif) === 'message'" class="w-5 h-5"
                                     [ngClass]="{'text-purple-600 dark:text-purple-400': getNotificationColor(notif) === 'purple'}"
                                     fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M2 5a2 2 0 012-2h7a2 2 0 012 2v4a2 2 0 01-2 2H9l-3 3v-3H4a2 2 0 01-2-2V5z"/>
                                    <path d="M15 7v2a4 4 0 01-4 4H9.828l-1.766 1.767c.28.149.599.233.938.233h2l3 3v-3h2a2 2 0 002-2V9a2 2 0 00-2-2h-1z"/>
                                </svg>
                                <!-- System Icon (default) -->
                                <svg *ngIf="getNotificationIcon(notif) === 'system'" class="w-5 h-5 text-gray-600 dark:text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                                </svg>
                            </div>
                            <!-- Unread indicator -->
                            <span *ngIf="!notif.isRead" class="absolute -top-0.5 -right-0.5 h-3 w-3 rounded-full bg-brand-500 border-2 border-white dark:border-gray-dark"></span>
                        </div>

                        <!-- Content -->
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-semibold text-gray-900 dark:text-white mb-1 line-clamp-1">
                                {{ notif.title }}
                            </p>
                            <p class="text-xs text-gray-600 dark:text-gray-400 mb-2 line-clamp-2">
                                {{ notif.message }}
                            </p>
                            <div class="flex items-center gap-2">
                                <span class="text-xs text-gray-500 dark:text-gray-500 capitalize">{{ notif.channel }}</span>
                                <span class="w-1 h-1 bg-gray-400 rounded-full"></span>
                                <span class="text-xs text-gray-500 dark:text-gray-500">{{ formatTimestamp(notif.createdAt) }}</span>
                            </div>
                        </div>
                    </button>
                </li>

                <!-- Loading Skeleton (when loading more) -->
                <ng-container *ngIf="isLoadingMore">
                    <li *ngFor="let i of [1,2,3,4,5]" class="mb-1 animate-pulse">
                        <div class="w-full flex gap-3 rounded-xl p-3 bg-gray-50 dark:bg-white/[0.02]">
                            <div class="w-10 h-10 rounded-full bg-gray-200 dark:bg-gray-700 flex-shrink-0"></div>
                            <div class="flex-1 space-y-2">
                                <div class="h-4 bg-gray-200 dark:bg-gray-700 rounded w-3/4"></div>
                                <div class="h-3 bg-gray-200 dark:bg-gray-700 rounded w-full"></div>
                                <div class="h-3 bg-gray-200 dark:bg-gray-700 rounded w-1/2"></div>
                            </div>
                        </div>
                    </li>
                </ng-container>
            </ng-container>

            <!-- Empty State -->
            <ng-template #emptyState>
                <li class="flex flex-col items-center justify-center py-12">
                    <div class="w-16 h-16 rounded-full bg-gray-100 dark:bg-gray-800 flex items-center justify-center mb-4">
                        <svg class="w-8 h-8 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/>
                        </svg>
                    </div>
                    <p class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1">No notifications yet</p>
                    <p class="text-xs text-gray-500 dark:text-gray-400">We'll notify you when something arrives</p>
                </li>
            </ng-template>
        </ul>

        <!-- Footer - Load More Button (First Load Only) -->
        <div *ngIf="showLoadMoreButton && !isLoadingMore" class="border-t border-gray-100 dark:border-gray-700 p-3">
            <button
                    (click)="loadMoreNotifications()"
                    class="block w-full px-4 py-2.5 text-sm font-semibold text-center text-brand-600 dark:text-brand-400 bg-brand-50 dark:bg-brand-900/10 hover:bg-brand-100 dark:hover:bg-brand-900/20 rounded-lg transition-colors"
            >
                View Previous Notifications
            </button>
        </div>

        <!-- Footer - Disabled State -->
        <div *ngIf="!showLoadMoreButton && !hasMoreToLoad && notifications.length > 0 && !isLoadingMore" class="border-t border-gray-100 dark:border-gray-700 p-3">
            <div class="block w-full px-4 py-2.5 text-sm font-medium text-center text-gray-400 dark:text-gray-600 bg-gray-50 dark:bg-gray-900/50 rounded-lg cursor-not-allowed">
                All notifications loaded
            </div>
        </div>
    </app-dropdown>
</div>